(function(resafety){var rs=resafety||{};window.resafety=window.rs=rs;rs._api_base="";(function(){var host;var scripts=document.getElementsByTagName("script");for(var i=0;i<scripts.length;i++){var src=scripts[i].src;if(src.indexOf("libs/resafety/build/resafety-1.19.5.min.js")>-1){rs._api_base=src.substring(0,src.indexOf("libs/resafety/build/resafety-1.19.5.min.js"));var link=document.createElement("link");link.rel="stylesheet";link.href=rs._api_base+"libs/resafety/css/core.css";if(scripts[i].nextSibling){scripts[i].parentNode.insertBefore(link,scripts[i].nextSibling)}else{scripts[i].parentNode.appendChild(link)}i=scripts.length}}})();rs._browser={versions:function(){var u=navigator.userAgent,app=navigator.appVersion;return{trident:u.indexOf("Trident")>-1,presto:u.indexOf("Presto")>-1,webKit:u.indexOf("AppleWebKit")>-1,gecko:u.indexOf("Gecko")>-1&&u.indexOf("KHTML")==-1,mobile:!!u.match(/AppleWebKit.*Mobile.*/),ios:!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:u.indexOf("Android")>-1||u.indexOf("Linux")>-1,iPhone:u.indexOf("iPhone")>-1||u.indexOf("Mac")>-1,iPad:u.indexOf("iPad")>-1,webApp:u.indexOf("Safari")==-1}}(),language:(navigator.browserLanguage||navigator.language).toLowerCase(),match:function(){var u=navigator.userAgent;return{Trident:u.indexOf("Trident")>0||u.indexOf("NET CLR")>0,Presto:u.indexOf("Presto")>0,WebKit:u.indexOf("AppleWebKit")>0,Gecko:u.indexOf("Gecko/")>0,Safari:u.indexOf("Safari")>0,Chrome:u.indexOf("Chrome")>0||u.indexOf("CriOS")>0,IE:u.indexOf("MSIE")>0||u.indexOf("Trident")>0,Edge:u.indexOf("Edge")>0,Firefox:u.indexOf("Firefox")>0,Opera:u.indexOf("Opera")>0||u.indexOf("OPR")>0,Vivaldi:u.indexOf("Vivaldi")>0,UC:u.indexOf("UC")>0||u.indexOf(" UBrowser")>0,QQBrowser:u.indexOf("QQBrowser")>0,QQ:u.indexOf("QQ/")>0,Baidu:u.indexOf("Baidu")>0||u.indexOf("BIDUBrowser")>0,Maxthon:u.indexOf("Maxthon")>0,LBBROWSER:u.indexOf("LBBROWSER")>0,"2345Explorer":u.indexOf("2345Explorer")>0,Sogou:u.indexOf("MetaSr")>0||u.indexOf("Sogou")>0,Wechat:u.indexOf("MicroMessenger")>0,Taobao:u.indexOf("AliApp(TB")>0,Alipay:u.indexOf("AliApp(AP")>0,Weibo:u.indexOf("Weibo")>0,Suning:u.indexOf("SNEBUY-APP")>0,iQiYi:u.indexOf("IqiyiApp")>0,Windows:u.indexOf("Windows")>0,Linux:u.indexOf("Linux")>0,Mac:u.indexOf("Macintosh")>0,Android:u.indexOf("Android")>0||u.indexOf("Adr")>0,WP:u.indexOf("IEMobile")>0,BlackBerry:u.indexOf("BlackBerry")>0||u.indexOf("RIM")>0||u.indexOf("BB")>0,MeeGo:u.indexOf("MeeGo")>0,Symbian:u.indexOf("Symbian")>0,iOS:u.indexOf("like Mac OS X")>0,Mobile:u.indexOf("Mobi")>0||u.indexOf("iPh")>0||u.indexOf("480")>0,Tablet:u.indexOf("Tablet")>0||u.indexOf("iPad")>0||u.indexOf("Nexus 7")>0}}(),detectZoom:function(){var ratio=0,screen=window.screen,ua=navigator.userAgent.toLowerCase();if(window.devicePixelRatio!==undefined){ratio=window.devicePixelRatio}else{if(~ua.indexOf("msie")){if(screen.deviceXDPI&&screen.logicalXDPI){ratio=screen.deviceXDPI/screen.logicalXDPI}}else{if(window.outerWidth!==undefined&&window.innerWidth!==undefined){ratio=window.outerWidth/window.innerWidth}}}rs._browser.ratioZoom=ratio;if(ratio){ratio=Math.round(ratio*100)}return ratio}};rs._browser.detectZoom();if(rs._browser.versions.trident||!window.JSON||!window.JSON.stringify){window.JSON2=function(){function f(n){return n<10?"0"+n:n}Date.prototype.toJSON=function(){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};var escapeable=/["\\\x00-\x1f\x7f-\x9f]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){return escapeable.test(string)?'"'+string.replace(escapeable,function(a){var c=meta[a];if(typeof c==="string"){return c}c=a.charCodeAt();return"\\u00"+Math.floor(c/16).toString(16)+(c%16).toString(16)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(typeof value.length==="number"&&!(value.propertyIsEnumerable("length"))){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value,rep);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){v=str(k,value,rep);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}return{stringify:function(value,replacer,space){var i;gap="";indent="";if(space){if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}}if(!replacer){rep=function(key,value){if(!Object.hasOwnProperty.call(this,key)){return undefined}return value}}else{if(typeof replacer==="function"||(typeof replacer==="object"&&typeof replacer.length==="number")){rep=replacer}else{throw new Error("JSON.stringify")}}return str("",{"":value})},parse:function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}if(/^[\],:{}\s]*$/.test(text.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")},quote:quote}}();if(window.JSON){window.JSON.stringify=window.JSON2.stringify}else{window.JSON=window.JSON2}}rs.define=function(full_name){var names=full_name.split(".");var pack=rs;for(var i=1;i<names.length-1;i++){if(!pack[names[i]]){pack[names[i]]={}}pack=pack[names[i]]}if(!pack[names[names.length-1]]){pack[names[names.length-1]]=function(){throw Error("no constructor Class")}}};rs.inherits=function(child_obj,parent_obj){child_obj.prototype=new parent_obj()};rs._log=function(info){if(window.console&&window.console.log){window.console.log(info)}else{}};rs._get=function(selector){if(selector.indexOf("#")==0){return document.getElementById(selector.substring(1))}return null};rs._html=function(dom,html){dom=rs._isString(dom)?document.getElementById(dom):dom;if(rs._isDom(dom)){dom.innerHTML=html}};rs._append=function(dom,html){dom=rs._isString(dom)?document.getElementById(dom):dom;if(rs._isDom(dom)){dom.innerHTML=dom.innerHTML+html}};rs._merge=function(){var src,copyIsArray,copy,name,options,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=arguments[i]||{};i++}if(typeof target!=="object"&&!rs._isFunction(target)){target={}}if(i===length){target=this;i--}for(;i<length;i++){if((options=arguments[i])!=null){for(name in options){src=target[name];copy=options[name];if(target===copy){continue}if(deep&&copy&&((copyIsArray=rs._isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&rs._isArray(src)?src:[]}else{clone=src?src:{}}target[name]=rs._merge(deep,clone,copy)}else{if(copy!==undefined){target[name]=copy}}}}}return target};rs._isFunction=function(obj){return(typeof obj)==="function"};rs._isString=function(obj){return(typeof obj)==="string"};rs._isArray=function(obj){return Object.prototype.toString.call(obj)==="[object Array]"};rs._isDom=function(obj){return typeof HTMLElement==="object"?obj instanceof HTMLElement:obj&&typeof obj==="object"&&obj.nodeType===1&&typeof obj.nodeName==="string"};rs._trim=function(text){return text==null?"":(text+"").replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")};rs._eventOn=function(obj,event_name,event_callback,is_one){if(!obj._event_list){throw Error("object has not _event_list")}if(rs._isString(event_callback)){if(window[event_callback]&&rs._isFunction(window[event_callback])){event_callback=window[event_callback]}else{throw Error(event_name+" callback is not a function")}}var name=event_name,namespace="";if(name.indexOf(".")>-1){name=event_name.substring(0,event_name.indexOf("."));namespace=event_name.substring(event_name.indexOf(".")+1)}if(!obj._event_list[name]){obj._event_list[name]=[]}obj._event_list[name].push({is_one:is_one,namespace:namespace,callback:event_callback})};rs._eventOnce=function(obj,event_name,event_callback){rs._eventOn(obj,event_name,event_callback,true)};rs._eventOff=function(obj,event_name){if(!obj._event_list){throw Error("object has not _event_list")}var name=event_name,namespace="";if(name.indexOf(".")>-1){name=event_name.substring(0,event_name.indexOf("."));namespace=event_name.substring(event_name.indexOf(".")+1)}var events=obj._event_list[name];if(!events||events.length==0){return}for(var i=0;i<events.length;i++){if(events[i].namespace==namespace){if(events[i].is_one){events.splice(i,1);i--}}}};rs._eventCall=function(obj,event_name,event_data){if(!(obj instanceof rs.View)&&!(obj instanceof rs.object.Base)&&!event_name){throw Error("_eventCall param error")}var name=event_name,namespace="";if(name.indexOf(".")>-1){name=event_name.substring(0,event_name.indexOf("."));namespace=event_name.substring(event_name.indexOf(".")+1)}var events=obj._event_list[name];if(!events||events.length==0){return}var data={referer:obj,type:name};if(event_data){data=rs._merge(data,event_data)}for(var i=0;i<events.length;i++){if(events[i].namespace==namespace&&events[i].callback){events[i].callback.call(obj,data);if(events[i].is_one){events.splice(i,1);i--}}}};rs._effect_group_id="olikjuhyybbxtyuvwfyxnfh";rs._serviceCall=function(view,service){var terminal_id=rs.page.get_url_param("terminal_id");if((!terminal_id||terminal_id=="")&&view.terminal_id){terminal_id=service.terminal_id}if(rs.page.in_resafety_browser()||(arguments.length===1&&terminal_id&&terminal_id!="")){rs.page.callService(view,service);return}if((!(view instanceof rs.View)&&!(view instanceof rs.RemoteView))||!service){throw Error("_serviceCall param error")}try{if(!rs._isArray(service)){service=[service]}var replaceToXYZ=function(json){if(json.longitude!=null&&json.latitude!=null&&json.height!=null&&typeof json.longitude!="undefined"&&typeof json.latitude!="undefined"&&typeof json.height!="undefined"){json.x=json.longitude;json.y=json.latitude;json.z=json.height;delete json.longitude;delete json.latitude;delete json.height}for(var key in json){if(json[key]!=null&&typeof json[key]=="object"){replaceToXYZ(json[key])}}};for(var i=0;i<service.length;i++){if(service[i].service_id&&(new RegExp("^effect.(.*).create$")).test(service[i].service_id)){if(!service[i].group_id){service[i].group_id=rs._effect_group_id}}if(view.opt.render=="3d-cloud"||view.opt.render=="3d-cloud-remote"){if(service[i].service_id=="entry_point.call_container_function"||service[i].service_id=="cloud_render.call_page_function"||service[i].service_id=="page.call_function"){var s=service[i];replaceToXYZ(s);var str=JSON.stringify(s);rs._log("回调："+str);var page_title=s.page_title;if(page_title&&typeof getIframe=="function"){var x=getIframe(page_title);document.getElementById(x).contentWindow[service[i].function_name](s)}else{window[service[i].function_name](s)}}else{if(service[i].service_id=="browser.open_module"){var s=service[i];replaceToXYZ(s);var str=JSON.stringify(s);rs._log(str);rs._open_module(view,s)}else{try{var s=service[i];replaceToXYZ(s);s.render_uuid=rs._getStorage("render_uuid");var str=JSON.stringify(s);str=str.replace(/entry_point.call_container_function/g,"page.call_function");rs._log(str);view._ws.send(str)}catch(e){alert("网络断开或者发送的消息不规范："+e)}}}}else{var s=service[i];replaceToXYZ(s);var str=JSON.stringify(s);rs._log(str);view._canvas.call_service(str)}}}catch(e){rs._log(e)}};rs._open_module=function(view,service){};rs._serviceCallbackCache={};rs._serviceCallback=function(service){};rs._random=function(){return(new Date()).getTime()+""+Math.round(Math.random()*1000)};rs._uuid=function(){var len=32;var radix=16;var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");var uuid=[],i;radix=radix||chars.length;if(len){for(i=0;i<len;i++){uuid[i]=chars[0|Math.random()*radix]}}else{var r;uuid[8]=uuid[13]=uuid[18]=uuid[23]="-";uuid[14]="4";for(i=0;i<36;i++){if(!uuid[i]){r=0|Math.random()*16;uuid[i]=chars[(i==19)?(r&3)|8:r]}}}return uuid.join("")};rs._formatColorHex=function(color){if(!color){return null}var r=255,g=255,b=255,a=1;color=color.replace(/\s|\n|\r/g,"");color=color.toLowerCase();if(color.indexOf("#")==0){color=color.substring(1);if(color.length==3){return"0xff"+color.substring(0,1)+color.substring(0,1)+color.substring(1,2)+color.substring(1,2)+color.substring(2,3)+color.substring(2,3)}else{if(color.length==6){return"0xff"+color.substring(0,2)+color.substring(2,4)+color.substring(4,6)}}}else{if(color.indexOf("rgba")==0){color=color.substring(4);color=color.substring(0,color.length-1);color=color.split(",");if(color.length==4){r=parseInt(color[0]);g=parseInt(color[1]);b=parseInt(color[2]);a=parseInt(color[3])}}else{if(color.indexOf("rgb")==0){color=color.substring(4);color=color.substring(0,color.length-1);color=color.split(",");if(color.length==3){r=parseInt(color[0]);g=parseInt(color[1]);b=parseInt(color[2])}}}}r=isNaN(r)?255:r>255?255:r<0?0:r;g=isNaN(g)?255:g>255?255:g<0?0:g;b=isNaN(b)?255:b>255?255:b<0?0:b;a=isNaN(r)?1:r>1?1:r<0?0:r;a=a*255;r=r.toString(16);g=g.toString(16);b=b.toString(16);a=a.toString(16);r=r.length==1?"0"+r:r;g=g.length==1?"0"+g:g;b=b.length==1?"0"+b:b;a=a.length==1?"0"+a:a;return"0x"+a+r+g+b};rs._ajax=function(url,data,callback){if(!url){return}data=!data?{}:data;var param="";for(var key in data){param+="&"+key+"="+encodeURIComponent(data[key])}if(param!=""){param=param.substring(1)}var request_url=rs._api_base+url;if(url.indexOf("http:")>-1){request_url=url}var crossDomain=null;var rurl=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/;var ajaxLocation;try{ajaxLocation=location.href}catch(e){ajaxLocation=document.createElement("a");ajaxLocation.href="";ajaxLocation=ajaxLocation.href}var ajaxLocParts=rurl.exec(ajaxLocation.toLowerCase())||[];if(crossDomain==null){var parts=rurl.exec(request_url.toLowerCase());crossDomain=!!(parts&&(parts[1]!==ajaxLocParts[1]||parts[2]!==ajaxLocParts[2]||(parts[3]||(parts[1]==="http:"?"80":"443"))!==(ajaxLocParts[3]||(ajaxLocParts[1]==="http:"?"80":"443"))))}if(crossDomain){var jsonp_callback_name="_jsonpCallback"+rs._random();rs[jsonp_callback_name]=function(){if(callback){callback.call(window,arguments[0])}rs[jsonp_callback_name]=null;delete rs[jsonp_callback_name]};var script=document.createElement("script");script.async=true;script.src=request_url+"?"+param+(param==""?"":"&")+"callback=rs."+jsonp_callback_name;script.onload=script.onreadystatechange=function(_,isAbort){if(isAbort||!script.readyState||/loaded|complete/.test(script.readyState)){script.onload=script.onreadystatechange=null;if(script.parentNode){script.parentNode.removeChild(script)}script=null}};var head=document.getElementsByTagName("head");if(head){head=head[0];head.insertBefore(script,head.firstChild)}}else{var xmlHttp=false;try{xmlHttp=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{xmlHttp=new ActiveXObject("Microsoft.XMLHTTP")}catch(e2){xmlHttp=false}}if(!xmlHttp&&typeof XMLHttpRequest!="undefined"){xmlHttp=new XMLHttpRequest()}if(!xmlHttp){return}xmlHttp.open("post",request_url,true);xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xmlHttp.onreadystatechange=function(){if(xmlHttp.readyState==4){if(xmlHttp.status==200){if(callback){var res=xmlHttp.responseText;if(res&&res!=""&&typeof res=="string"){res=eval("("+res+")")}callback.call(window,res)}}else{rs._log("ajax error："+xmlHttp.status)}}};xmlHttp.send(param)}};rs._setCookie=function(name,value,days){var Days=30;if(days){Days=days}var exp=new Date();exp.setTime(exp.getTime()+Days*24*60*60*1000);document.cookie=name+"="+escape(value)+";expires="+exp.toGMTString()};rs._getCookie=function(name){var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");if(arr=document.cookie.match(reg)){return unescape(arr[2])}else{return null}};rs._setStorage=function(name,value,type){if(window.sessionStorage&&window.localStorage){if(type=="local"){localStorage[name]=value}else{sessionStorage[name]=value}}else{rs._setCookie(name,value)}};rs._getStorage=function(name,type){if(window.sessionStorage&&window.localStorage){if(type=="local"){return localStorage[name]}else{return sessionStorage[name]}}else{return rs._getCookie(name)}};rs._delStorage=function(name,type){if(window.sessionStorage&&window.localStorage){if(type=="local"){localStorage.removeItem(name)}else{sessionStorage.removeItem(name)}}else{}};rs.exeinfo={};rs.exeinfo.browser_type=32;if(navigator.userAgent.toLowerCase().indexOf("win64")>=0||navigator.userAgent.toLowerCase().indexOf("wow64")>=0){rs.exeinfo.browser_type=64}rs.exeinfo.ocx_file="Setup"+rs.exeinfo.browser_type+".exe";rs.exeinfo.cloud_ser="protocol.exe";rs.exeinfo.filepath="";rs.server_info={init:function(callback){if(rs.server_info.info){callback()}else{rs._ajax("ms/terminal/server_info",{},function(res){rs._log(JSON.stringify(res));if(!res||res==""){rs._log("error：服务器端返回配置信息错误！");return}rs.server_info.info=res;callback()})}},get:function(key){return rs.server_info.info[key]},getByType:function(type){var servers=rs.server_info.get("servers");for(var i=0;i<servers.length;i++){if(servers[i].f_type==type){servers=servers[i];break}}return servers}};rs.EleResize={_handleResize:function(e){var ele=e.target||e.srcElement;var trigger=ele.__resizeTrigger__;if(trigger){var handlers=trigger.__z_resizeListeners;if(handlers){var size=handlers.length;for(var i=0;i<size;i++){var h=handlers[i];var handler=h.handler;var context=h.context;handler.apply(context,[e])}}}},_removeHandler:function(ele,handler,context){var handlers=ele.__z_resizeListeners;if(handlers){var size=handlers.length;for(var i=0;i<size;i++){var h=handlers[i];if(h.handler===handler&&h.context===context){handlers.splice(i,1);return}}}},_createResizeTrigger:function(ele){var obj=document.createElement("object");obj.setAttribute("style","display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden;opacity: 0; pointer-events: none; z-index: -1;");obj.onload=rs.EleResize._handleObjectLoad;obj.type="text/html";ele.appendChild(obj);obj.data="about:blank";return obj},_handleObjectLoad:function(evt){this.contentDocument.defaultView.__resizeTrigger__=this.__resizeElement__;this.contentDocument.defaultView.addEventListener("resize",rs.EleResize._handleResize)}};if(document.attachEvent){rs.EleResize.on=function(ele,handler,context){var handlers=ele.__z_resizeListeners;if(!handlers){handlers=[];ele.__z_resizeListeners=handlers;ele.__resizeTrigger__=ele;ele.attachEvent("onresize",rs.EleResize._handleResize)}handlers.push({handler:handler,context:context})};rs.EleResize.off=function(ele,handler,context){var handlers=ele.__z_resizeListeners;if(handlers){rs.EleResize._removeHandler(ele,handler,context);if(handlers.length===0){ele.detachEvent("onresize",rs.EleResize._handleResize);delete ele.__z_resizeListeners}}}}else{rs.EleResize.on=function(ele,handler,context){var handlers=ele.__z_resizeListeners;if(!handlers){handlers=[];ele.__z_resizeListeners=handlers;if(getComputedStyle(ele,null).position==="static"){ele.style.position="relative"}var obj=rs.EleResize._createResizeTrigger(ele);ele.__resizeTrigger__=obj;obj.__resizeElement__=ele}handlers.push({handler:handler,context:context})};rs.EleResize.off=function(ele,handler,context){var handlers=ele.__z_resizeListeners;if(handlers){rs.EleResize._removeHandler(ele,handler,context);if(handlers.length===0){var trigger=ele.__resizeTrigger__;if(trigger){trigger.contentDocument.defaultView.removeEventListener("resize",rs.EleResize._handleResize);ele.removeChild(trigger);delete ele.__resizeTrigger__}delete ele.__z_resizeListeners}}}}rs._views=[]})(window.resafety);rs.event={};rs.event.ready="ready";rs.event.click="click";rs.event.dblclick="dblclick";rs.event.mouseup="mouseup";rs.event.mousedown="mousedown";rs.event.mousemove="mousemove";rs.event.mouseenter="mouseenter";rs.event.mouseleave="mouseleave";rs.event.keydown="keydown";rs.event.keyup="keyup";rs.event.dragstart="dragstart";rs.event.drag="drag";rs.event.dragend="dragend";rs.event.hold="hold";rs.tools={};rs.tools.measure=function(a){};rs.tools.layerControl=function(){};rs.define("rs.View");rs.View=function(c){this._canvas=null;this._canvas_id="resafety-web3d-embed";this._canvas_3dcloud_ocx=null;this._exe_title="";this._dom_id=null;this._deepeye_cloud_param={};this._deepeye_dispatch_addr="";this._width="";this._height="";this._event_list={};this._layer_list=[];var d="de_view_dom_";var a={render:"3d",dom:null,version:"1.16",camera:null,layers:[],events:{}};var b={};if(rs._isString(c)){this._dom_id=c;b.dom=rs._get("#"+c)}else{if(rs._isDom(c)){b.dom=c}else{b=c}}this.opt=rs._merge({},a,b);if(!this.opt.dom){throw Error("no dom for View")}else{if(!rs._isDom(this.opt.dom)){this.opt.dom=rs._get("#"+this.opt.dom)}}if(this.opt.render==="3d-cloud"&&!rs._browser.match.Windows){this.opt.render="3d-cloud-remote"}if(!this._dom_id){this._dom_id=this.opt.dom}if(this.opt.layers){this._layer_list=this._layer_list.concat(this.opt.layers)}this._resize=function(){rs._browser.detectZoom();this._width=this.opt.dom.clientWidth;this._height=this.opt.dom.clientHeight};this._resize();this.embed={};this.embed.object_html='<object id="$id$" classid="CLSID:F2E5BC9D-6D36-4FC6-A502-41B391D01AD9" width="100%" height="100%"><div style="display:none;"><p>本地尚未安装三维平台客户端插件，请安装浏览器上方黄色提示条或弹出提示框中的三维平台客户端插件</p><p>或者点击以下链接下载安装<a href="'+rs._api_base+"f/"+rs.exeinfo.ocx_file+'">三维平台客户端插件</a></p><p>安装完成后请重新启动浏览器</p></div><iframe src="'+rs._api_base+'libs/resafety/guide/widgetD.jsp" frameborder="0" style="width:100%;height:100%;"></iframe></object>';this.embed.update_object_html='<div style="display:none;"><p>三维平台客户端插件需要更新</p><p>请点击下载<a href="'+rs._api_base+"f/"+rs.exeinfo.ocx_file+'">三维平台客户端插件</a>，并<font color="red">保存到指定目录</font></p><p>下载完成后<font color="red">关闭浏览器</font>，再双击运行您刚下载的文件</p><p>待安装完成后重新打开该地址即可</p></div><iframe src="'+rs._api_base+'libs/resafety/guide/widgetU.jsp" frameborder="0" style="width:100%;height:100%;"></iframe>';this.embed.npapi_html='<embed pluginspage="'+rs._api_base+"f/"+rs.exeinfo.ocx_file+'" id="$id$" type="application/nplocalrender" width="100%" height="100%" codebase="/f/'+rs.exeinfo.ocx_file+'"><div style="display:none;"><p>本地尚未安装三维平台客户端插件，请安装浏览器上方黄色提示条或弹出提示框中的三维平台客户端插件</p><p>或者点击以下链接下载安装<a href="'+rs._api_base+"f/"+rs.exeinfo.ocx_file+'">三维平台客户端插件</a></p><p>安装完成后请重新启动浏览器</p></div><iframe src="'+rs._api_base+'libs/resafety/guide/widgetD.jsp" frameborder="0" style="width:100%;height:100%;"></iframe></embed>';this.embed.canvas_html='<canvas id="$id$">浏览器不支持canvas</canvas>';this.embed.loading_html='<link href="'+rs._api_base+'libs/resafety/guide/css/resafety.css" rel="stylesheet" type="text/css" /><div class="rs" style="background:#031322 url('+rs._api_base+'libs/resafety/guide/img/bg.png) no-repeat center center;"><div class="rs-top" style="background:url('+rs._api_base+'libs/resafety/guide/img/topbg.png) no-repeat center top;"></div><div class="rs-content"><div class="rs-circle" style="background-image:url('+rs._api_base+'libs/resafety/guide/img/cirbg.png);"><img src="'+rs._api_base+'libs/resafety/guide/img/light.png" class="rs-circle-light" /></div><div id="cloudLoadingText1" class="rs-text">正在检测环境信配置信息...</div><div id="cloudLoadingText2" class="rs-text">&nbsp;</div><div id="cloudLoadingText3" class="rs-text">&nbsp;</div></div><div class="rs-scroll"><div id="rsScrollIn" class="rs-scroll-in"><div class="rs-scroll-in-shadue" style="background-image:url('+rs._api_base+'libs/resafety/guide/img/shaduebg.png);"><span id="cloudSliderText">0</span>%</div></div></div></div>';this.embed.cloudOcx_html='<object id="$id$Ocx" classid="CLSID:F2E5BC9D-6D36-4FC6-A502-41B391D01AD9" width="100%" height="100%"><div><p>本地尚未安装三维平台客户端插件，请安装浏览器上方黄色提示条或弹出提示框中的三维平台客户端插件</p><p>或者点击以下链接下载安装<a href="'+rs._api_base+"f/"+rs.exeinfo.ocx_file+'">三维平台客户端插件</a></p><p>安装完成后请重新启动浏览器</p></div></object>';this.embed.protocol_html='<link href="'+rs._api_base+'libs/resafety/guide/css/resafety.css" rel="stylesheet" type="text/css" /><div class="rs" style="background:#031322 url('+rs._api_base+'libs/resafety/guide/img/bg.png) no-repeat center center;"><div class="rs-top" style="background:url('+rs._api_base+'libs/resafety/guide/img/topbg.png) no-repeat center top;"></div><div class="rs-content"><div class="rs-circle" style="background-image:url('+rs._api_base+'libs/resafety/guide/img/cirbg.png);"><img src="'+rs._api_base+'libs/resafety/guide/img/light.png" class="rs-circle-light" /></div><div class="rs-text-hint">本地尚未安装三维渲染服务<br/>点击以下链接下载安装</div><div class="rs-button-div"><a class="rs-a-button" style="background-image:url('+rs._api_base+'libs/resafety/guide/img/button.png);" href="$filepath$">立即下载</a></div><div class="rs-text">*安装完成请重启浏览器*</div></div></div>';this.embed.update_protocol_html='<link href="'+rs._api_base+'libs/resafety/guide/css/resafety.css" rel="stylesheet" type="text/css" /><div class="rs" style="background:#031322 url('+rs._api_base+'libs/resafety/guide/img/bg.png) no-repeat center center;"><div class="rs-top" style="background:url('+rs._api_base+'libs/resafety/guide/img/topbg.png) no-repeat center top;"></div><div class="rs-content"><div class="rs-circle" style="background-image:url('+rs._api_base+'libs/resafety/guide/img/cirbg.png);"><img src="'+rs._api_base+'libs/resafety/guide/img/light.png" class="rs-circle-light" /></div><div class="rs-text-hint">本地三维渲染服务版本过低<br/>点击以下链接下载升级</div><div class="rs-button-div"><a class="rs-a-button" style="background-image:url('+rs._api_base+'libs/resafety/guide/img/button.png);" href="$filepath$">立即下载</a></div><div class="rs-text">*升级完成请重启浏览器*</div></div></div>';this.check_version=function(e,m){var j=[],g=m.split(".");if(e){j=e.split(".")}var l=false;for(var f=0;f<g.length;f++){if(j.length>f){var k=parseFloat(j[f]);var h=parseFloat(g[f]);if(!isNaN(k)&&!isNaN(h)&&h>k){l=true;break}else{if(!isNaN(k)&&!isNaN(h)&&h<k){l=false;break}}}else{l=true;break}}return l};rs._views.push(this)};rs.View.prototype.auth=function(a){var b=this;b._login_info=a};rs.View.prototype.draw=function(callback){var _view=this;var render=_view.opt.render;var dom=_view.opt.dom;if(callback){_view.on(rs.event.ready,callback)}var timerCount=0;var callLaodWindow=function(){if(timerCount>100){_view._canvas=null;throw Error("View load failure")}setTimeout(function(){timerCount++;if(_view._canvas){try{if(_view.check_version(_view._canvas.get_version(),rs.server_info.info.last_ocx_version)){rs._html(dom,_view.embed.update_object_html);_view._canvas=null;return}var config={servers:rs.server_info.info.servers};if(_view._login_info){config.login_info=_view._login_info}_view._canvas.set_config(JSON.stringify(config));_view._canvas.load_window("");getWindowLoadState()}catch(e){rs._log(e);callLaodWindow()}}else{callLaodWindow()}},500)};var getWindowLoadState=function(){var state;try{state=_view._canvas.get_load_state()}catch(e){rs._log(e);setTimeout(getWindowLoadState,500);return}if(state){rs._serviceCall(_view,{service_id:"effect.destroy",group_id:rs._effect_group_id});rs._eventCall(_view,rs.event.ready)}else{setTimeout(getWindowLoadState,500)}};var timer3DCloudCount=0;var callLaodWindow3DCloud=function(){if(timer3DCloudCount>100){_view._canvas_3dcloud_ocx=null;throw Error("View load failure")}setTimeout(function(){timer3DCloudCount++;if(_view._canvas_3dcloud_ocx){try{if(_view.check_version(_view._canvas_3dcloud_ocx.get_version(),rs.server_info.info.last_ocx_version)){rs._html(dom,_view.embed.update_object_html);_view._canvas_3dcloud_ocx=null;return}var config={servers:rs.server_info.info.servers};if(_view._login_info){config.login_info=_view._login_info}_view._canvas_3dcloud_ocx.set_config(JSON.stringify(config));_view._canvas_3dcloud_ocx.load_window("");_view._canvas_3dcloud_ocx.set_render_type(2);getWindowLoadState3DCloud()}catch(e){rs._log(e);callLaodWindow3DCloud()}}else{callLaodWindow3DCloud()}},500)};var getWindowLoadState3DCloud=function(){var state;try{state=_view._canvas_3dcloud_ocx.get_load_state()}catch(e){rs._log(e);setTimeout(getWindowLoadState3DCloud,500);return}if(state){setTimeout(readyLoad,500)}else{setTimeout(getWindowLoadState3DCloud,500)}};var readyLoad=function(ws_location){connectWebsocket(ws_location,afterLoad)};var afterLoad=function(){setTimeout(afterLoadDelay,2000)};function afterLoadDelay(){var service={service_id:"entry_point.get_terminal_id",callback_service:{service_id:"page.call_function",function_name:"readyPage",terminal_id:"$terminal_id$"}};rs._serviceCall(_view,service)}var readyPage=function(data){if(data){var json=eval("("+data+")");if(json.terminal_id){_view._terminal_id=json.terminal_id}else{_view._terminal_id=json.value}if(_view._terminal_id!=""){rs._setStorage("terminal_id",_view._terminal_id)}}rs._serviceCall(_view,{service_id:"effect.destroy",group_id:rs._effect_group_id});rs._eventCall(_view,rs.event.ready)};var initEmbed=function(){if(!rs._get("#"+_view._canvas_id)){if(rs._browser.versions.webKit){rs._html(dom,_view.embed.npapi_html.replace(/\$id\$/g,_view._canvas_id))}else{rs._html(dom,_view.embed.object_html.replace(/\$id\$/g,_view._canvas_id))}_view._canvas=window[_view._canvas_id];if(!rs.server_info.info.last_ocx_version||rs.server_info.info.last_ocx_version==""){rs._log("error：服务器端未配置ocx版本号！");return}callLaodWindow()}};var initCloudRemote=function(){rs._html(dom,'<div style="background:url('+rs._api_base+'start.png) repeat; width:100%;height:100%;z-index:50000;"><div id="loadingtextimg" style="position:absolute;text-align:center;bottom:200px;width:100%;background:transparent;"><img src="'+rs._api_base+'loading.gif"/></div><div id="loadingtext" style="position:absolute;text-align:center;bottom:100px;width:100%;background-color:black;color:yellow;">正在检测环境信配置信息...</div></div>');rs._ajax("ms/terminal/server_info",{},function(res){rs._log(JSON.stringify(res));var render_uuid=rs._getCookie("render_uuid");if(!render_uuid){render_uuid=rs._uuid();rs._setCookie("render_uuid",render_uuid)}var services=res.servers;var newservices={};for(var i=0;i<services.length;i++){if(services[i].f_type==4){var terminal_id=rs._getCookie("terminal_id");services[i].f_port="7000";services[i].f_addr="192.168.100.70";var browser_name=rs._browser.match;if(browser_name.Chrome){browser_name="chrome"}else{if(browser_name.IE){browser_name="ie"}else{browser_name=""}}newservices={render_uuid:render_uuid,browser_type:browser_name,dispatch_server_port:services[i].f_port,dispatch_server_ip:services[i].f_addr,system_name:document.title};rs._deepeye_cloud_param=newservices;rs._deepeye_dispatch_addr="http://"+services[i].f_addr+":"+services[i].f_port+"/renderer?uuid="+render_uuid+"&is_pc=0";if(!terminal_id){newservices.terminal_id="";callLoadCloudState(render_uuid)}else{}break}}})};var initCloud=function(){if(rs._browser.versions.mobile){initCloudRemote()}else{if(typeof WebSocket=="undefined"){rs._html(dom,'<div style="background:url('+rs._api_base+'start.png) repeat; width:100%;height:100%;z-index:50000;"><div id="loadingtext" style="position:absolute;text-align:center;bottom:100px;width:100%;background-color:black;color:yellow;">浏览器不支持WebSocket协议，请使用IE10及其以上版本的浏览器。</div></div>');return}connectHost.init()}};var connectHost={params:function(){var params={loadWaitingTime:0,connectLocation:"ws://127.0.0.1:8000/websocket",connectServices:{}};var render_uuid=rs._getStorage("render_uuid");if(!render_uuid){render_uuid=rs._uuid();rs._setStorage("render_uuid",render_uuid)}var terminal_id=rs._getStorage("terminal_id");if(!terminal_id){terminal_id=""}var browser_name="";if(rs._browser.match.Chrome){browser_name="chrome"}else{if(rs._browser.match.IE){browser_name="ie"}}params.connectServices={browser_type:browser_name,is_pc:1,terminal_id:terminal_id};return params}(),init:function(){var servers=rs.server_info.getByType(7);rs.exeinfo.filepath="http://"+servers.f_addr+":"+servers.f_port+"/cloud_ser/"+rs.exeinfo.cloud_ser;servers=rs.server_info.getByType(8);connectHost.params.connectServices.dispatch_server_port=servers.f_port;connectHost.params.connectServices.dispatch_server_ip=servers.f_addr;connectHost.connect()},check:false,connect:function(){var param=JSON.stringify(connectHost.params.connectServices);param="deepeyecloud://"+param;var ws=new WebSocket(connectHost.params.connectLocation);ws.binaryType="arraybuffer";ws.onopen=function(){ws.send("version")};ws.onmessage=function(e){var str=e.data;var json={};try{json=eval("("+str+")")}catch(e){return}connectHost.check=true;if(json.version){if(_view.check_version(json.version,rs.server_info.info.last_cloud_version)){rs._log("please install 3d protocol,startup agign!");rs._html(dom,_view.embed.update_protocol_html.replace(/\$filepath\$/g,rs.exeinfo.filepath));_view._canvas=null;return}ws.send(param)}else{if(json.uuid){connectHost.params.connectServices.render_uuid=json.uuid;rs._html(dom,_view.embed.loading_html);connectHost.load()}}};ws.onclose=function(msg){if(!connectHost.check){connectHost.check=true;rs._log("please install 3d protocol,startup agign!");rs._html(dom,_view.embed.protocol_html.replace(/\$filepath\$/g,rs.exeinfo.filepath));_view._canvas=null}};ws.onerror=function(msg){rs._log("onerror")}},load:function(){var param={uuid:connectHost.params.connectServices.render_uuid,is_pc:connectHost.params.connectServices.is_pc};var deepeye_dispatch_addr="http://"+connectHost.params.connectServices.dispatch_server_ip+":"+connectHost.params.connectServices.dispatch_server_port+"/renderer";rs._ajax(deepeye_dispatch_addr,param,function(res){rs._log(JSON.stringify(res));if(!res||res==""){rs._log("error：服务器端云渲染程序版本不对！");return}var cloud_info=res;cloud_info.ws_location="ws://"+res.ip+":"+res.port;var state=res.state;if(state=="update"){rs._html(dom,_view.embed.update_protocol_html.replace(/\$filepath\$/g,rs.exeinfo.filepath))}else{if(state=="waiting"){rs._log("正在等待服务器响应...");document.getElementById("cloudLoadingText1").innerText="正在等待服务器响应...";if(connectHost.params.loadWaitingTime<(3600000/900)){connectHost.params.loadWaitingTime++;setTimeout(connectHost.load(),900)}}else{if(state=="success"){_view._canvas_3dcloud_ocx="cloud";document.getElementById("cloudLoadingText1").innerText="开始建立网络连接...";connectWebsocket(cloud_info.ws_location,"",param.uuid)}}}})}};var ws_type;var ws_code;var checkWindowProtocolInstall=function(){var protocol_url="deepeyecloud://";var assistEl=document.getElementById("trigger_protocol_btn");var triggerEl=document.getElementById("trigger_protocol_ifrm");var timeout;if(ws_type){}if(!rs._get("#"+_view._canvas_id)||ws_type){rs._html(dom,'<iframe id="trigger_protocol_ifrm"  name="trigger_protocol_ifrm"  style="display:none"></iframe><button id="trigger_protocol_btn" style="position:absolute;left:9999px;top:99999px;"></button>');if(timeout){clearTimeout(timeout)}assistEl=document.getElementById("trigger_protocol_btn");triggerEl=document.getElementById("trigger_protocol_ifrm")}function check(){var render_uuid=rs._getStorage("render_uuid");if(!render_uuid){render_uuid=rs._uuid();rs._setStorage("render_uuid",render_uuid)}var servers=rs.server_info.getByType(8);var newservices={};var terminal_id=rs._getStorage("terminal_id");var browser_name="";if(rs._browser.match.Chrome){browser_name="chrome"}else{if(rs._browser.match.IE){browser_name="ie"}}newservices={render_uuid:render_uuid,browser_type:browser_name,dispatch_server_port:servers.f_port,dispatch_server_ip:servers.f_addr,system_name:encodeURIComponent(document.title),is_pc:1};rs._deepeye_cloud_param=newservices;rs._deepeye_dispatch_addr="http://"+servers.f_addr+":"+servers.f_port+"/renderer";servers=rs.server_info.getByType(7);rs.exeinfo.filepath="http://"+servers.f_addr+":"+servers.f_port+"/cloud_ser/"+rs.exeinfo.cloud_ser;if(!terminal_id||ws_type){ws_type="";ws_code="";newservices.terminal_id=""}else{newservices.terminal_id=terminal_id}startupProtocol(render_uuid,newservices)}function startupProtocol(render_uuid,newservices){var param=JSON.stringify(newservices);param=param.replace(/\"/g,'\\"');var url=protocol_url+encodeURIComponent(param);launchApplication(url,function(){rs._log("startup program success."+url);rs._html(dom,_view.embed.loading_html);callLoadCloudState(render_uuid)},function(){rs._log("please install 3d protocol,startup agign!");rs._html(dom,_view.embed.protocol_html.replace(/\$filepath\$/g,rs.exeinfo.filepath))})}var isDone=true;function done(){isDone=true;assistEl.onblur=null;triggerEl.onerror=null;clearTimeout(timeout)}function findIEVersion(){var ieVersion=window.navigator.platform;if(ieVersion.indexOf("32")!=-1){return 32}else{if(ieVersion.indexOf("64")>=0){return 64}}}function launchApplication(url,success,fail){var isSuccess=false;if(!isDone){return}isDone=false;assistEl.focus();assistEl.onblur=function(){if(document.activeElement&&document.activeElement!==assistEl){assistEl.focus()}else{if(!isSuccess){isSuccess=true;done();success()}}};timeout=setTimeout(function(){done();fail()},4000);triggerEl.onerror=function(){done();fail()};try{triggerEl.src=url}catch(e){done();fail();return}}check()};var setTimeoutByCallLoadCloudState=0;function callLoadCloudState(render_uuid){var param={uuid:rs._deepeye_cloud_param.render_uuid,is_pc:rs._deepeye_cloud_param.is_pc};rs._ajax(rs._deepeye_dispatch_addr,param,function(res){rs._log(JSON.stringify(res));if(!res||res==""){rs._log("error：服务器端云渲染程序版本不对！");return}var cloud_info=res;cloud_info.ws_location="ws://"+res.ip+":"+res.port;var state=res.state;if(state=="update"){rs._html(dom,_view.embed.update_protocol_html.replace(/\$filepath\$/g,rs.exeinfo.filepath))}else{if(state=="waiting"){rs._log("正在等待服务器响应...");document.getElementById("cloudLoadingText1").innerText="正在等待服务器响应...";if(setTimeoutByCallLoadCloudState<(3600000/900)){setTimeoutByCallLoadCloudState++;setTimeout(callLoadCloudState(render_uuid),900)}}else{if(state=="success"){_view._canvas_3dcloud_ocx="cloud";document.getElementById("cloudLoadingText1").innerText="开始建立网络连接...";connectWebsocket(cloud_info.ws_location,"",render_uuid)}}}})}var checkCloudVersion=function(current_version,last_version){document.getElementById("cloudLoadingText1").innerText="检测版本号信息...";if(current_version&&current_version==last_version){document.getElementById("cloudLoadingText1").innerText="检测版本号信息("+current_version+")...";return true}var cv_arr=current_version.split(".");var lv_arr=last_version.split(".");var cv_len=cv_arr.length;var lv_len=lv_arr.length;var max_len=cv_len<lv_len?lv_len:cv_len;if(cv_len<lv_len){for(var i=cv_len;i<lv_len;i++){cv_arr[i]=0}}else{if(cv_len>lv_len){for(var i=lv_len;i<cv_len;i++){lv_arr[i]=0}}}var flag;for(var i=0;i<max_len;i++){if(cv_arr[i]<lv_arr[i]){flag=false;break}else{if(cv_arr[i]>lv_arr[i]){flag=true;break}}}document.getElementById("cloudLoadingText1").innerText="检测版本号信息("+current_version+")...";return flag};var connectWebsocket=function(ws_location,callback,render_uuid){if(!rs._get("#"+_view._canvas_id)){var ctx;var img;var lbt=0;var rbt=0;var mbt=0;var canvas_width;var canvas_height;if(!ws_location&&typeof REMOTE_SERVER_3D_CLOUD!="undefined"&&REMOTE_SERVER_3D_CLOUD!=""){ws_location=REMOTE_SERVER_3D_CLOUD}if(!ws_location){ws_location="ws://127.0.0.1:7006/ws"}ws_location=ws_location+"/ws?uuid="+render_uuid;_view._ws=new WebSocket(ws_location);_view._ws.binaryType="arraybuffer";_view._ws.onopen=function(){document.getElementById("cloudLoadingText1").innerText="正在打开网络连接...";_view._ws.send(JSON.stringify({service_id:"websocket_server.start_process",render_uuid:render_uuid}));if(render!="3d-cloud"){startCapture()}};function resizeView(){_view._resize();var canvas_width=_view._width;var canvas_height=_view._height;if(console){console.log(canvas_width+","+canvas_height)}_view._canvas.width=canvas_width;_view._canvas.height=canvas_height;var service={service_id:"renderer.set_window_rect",width:Math.round(rs._browser.ratioZoom*_view._width),height:Math.round(rs._browser.ratioZoom*_view._height),render_uuid:render_uuid};_view._ws.send(JSON.stringify(service))}function resumeView(){var service={service_id:"commonappfunction.enable_render_window",render:1,render_uuid:render_uuid};_view._ws.send(JSON.stringify(service))}function parseView(){var service={service_id:"commonappfunction.enable_render_window",render:0,render_uuid:render_uuid};_view._ws.send(JSON.stringify(service))}function closeView(){_view._ws.close()}function initCanvas(){rs._html(dom,_view.embed.canvas_html.replace(/\$id\$/g,_view._canvas_id));_view._canvas=window[_view._canvas_id];var canvas_width=_view._width;var canvas_height=_view._height;_view._canvas.width=canvas_width;_view._canvas.height=canvas_height;initEvent(callback)}var startCapture=function(){};var first=true;var first_message="";_view._ws.onmessage=function(e){if((typeof e.data)!="string"){var x=new Int16Array(e.data,0,8);var pleft=parseInt(x[0].toString());var ptop=parseInt(x[1].toString());var pright=parseInt(x[2].toString());var pbottom=parseInt(x[3].toString());if(first&&pleft==0&&ptop==0&&pright==Math.round(rs._browser.ratioZoom*_view._width)&&pbottom==Math.round(rs._browser.ratioZoom*_view._height)){initCanvas();drawBlob(e.data)}if(!first){drawBlob(e.data)}if(first&&pleft==0&&ptop==0&&pright==Math.round(rs._browser.ratioZoom*_view._width)&&pbottom==Math.round(rs._browser.ratioZoom*_view._height)){readyPage(first_message);first=false}}else{var str=e.data;var arg=str.substring(1);var type=str.substring(0,1);if(type==0){drawBase64(arg)}else{var json={};try{json=eval("("+arg+")")}catch(e){return}if(json.service_id=="websocket_server.progress"){if(json.type=="update"){console.log("更新状态："+json.value.type);document.getElementById("cloudLoadingText1").innerText="正在升级更新中...";var v=false;if(json.value&&json.value.value&&!isNaN(json.value.value)){v=(Math.round(parseFloat(json.value.value)*10000)/100)}switch(json.value.type){case"all_pro":if(v){document.getElementById("cloudSliderText").innerText=v;document.getElementById("rsScrollIn").style.width=v+"%"}break;case"file_name":document.getElementById("cloudLoadingText2").innerText="正在更新模块"+json.value.value;break;case"cur_pro":if(v){document.getElementById("cloudLoadingText3").innerText="已更新("+v+"%)..."}break;default:break}}else{if(json.type=="load"){rs._log("正在努力加载中..."+json.value);document.getElementById("cloudLoadingText1").innerText="正在努力加载中...";document.getElementById("cloudLoadingText2").innerHTML="&nbsp";document.getElementById("cloudLoadingText3").innerHTML="&nbsp";if(json.value&&!isNaN(json.value)){var v=Math.round(json.value*10000)/100;document.getElementById("cloudSliderText").innerText=v;document.getElementById("rsScrollIn").style.width=v+"%"}}else{if(json.type=="complete"){rs._log("程序加载完毕。");document.getElementById("cloudLoadingText1").innerText="";rs._log("WebSocket 启动render_uuid与terminal_id关联。便于三维程序退出时，清除缓存。");first=true;first_message=arg;var canvas_width=_view._width;var canvas_height=_view._height;var service={service_id:"renderer.set_window_rect",width:Math.round(rs._browser.ratioZoom*_view._width),height:Math.round(rs._browser.ratioZoom*_view._height),render_uuid:render_uuid};_view._ws.send(JSON.stringify(service));_view._ws.send(JSON.stringify({service_id:"cloud_render.update",render_uuid:render_uuid}))}}}}else{if(json.service_id=="cloud_render.call_page_function"){try{eval(json.function_name+"(arg);")}catch(e){alert("没有找到回调函数："+json.function_name)}}else{if(json.service_id=="reload.shell_except"){}else{var obj="";try{obj=eval("("+arg+")")}catch(e){obj="";rs._log("接收到错误消息！")}if(obj){rs._serviceCall(_view,obj)}}}}}}};var drawBase64=function(data){if(!ctx){var c=_view._canvas;ctx=c.getContext("2d");img=new Image();img.onload=function(){ctx.clearRect(0,0,canvas_width,canvas_height);ctx.drawImage(img,0,0)}}img.src="data:image/png;base64,"+data};var drawBlob=function(data){if(!ctx){var c=_view._canvas;ctx=c.getContext("2d");img=new Image();var ratio=rs._browser.ratioZoom;img.onload=function(){ctx.drawImage(this,0,0,this.right-this.left,this.bottom-this.top,(this.left/ratio),(this.top*ratio),((this.right-this.left)/ratio),((this.bottom-this.top)/ratio))}}if(img.src){URL.revokeObjectURL(img.src)}var date=new Date();var start=date.getTime();var x=new Int16Array(data,0,8);img.left=parseInt(x[0].toString());img.top=parseInt(x[1].toString());img.right=parseInt(x[2].toString());img.bottom=parseInt(x[3].toString());var blob=new Blob([new Int8Array(data,8,data.byteLength-8)],{type:"image/PNG"});if(blob){img.src=URL.createObjectURL(blob)}blob=null};function sliceBlob(blob,start,end,type){type=type||blob.type;if(blob.mozSlice){return blob.mozSlice(start,end,type)}else{if(blob.webkitSlice){return blob.webkitSlice(start,end,type)}else{if(blob.slice){return blob.slice(start,end,type)}else{throw new Error("This doesn't work!")}}}}_view._ws.onclose=function(msg){console.log(arguments);rs._log("onclose");rs._log("code:"+msg.code);rs._log("type:"+msg.type)};_view._ws.onerror=function(msg){rs._log("onerror")};var initEvent=function(callback){document.oncontextmenu=function(){return false};document.ondragstart=function(){return false};document.onselectstart=function(){return false};document.onbeforecopy=function(){return false};document.onselect=function(){document.selection.empty()};document.oncopy=function(){document.selection.empty()};if(navigator.appName.indexOf("Microsoft Internet Explorer")!=-1){if(window.attachEvent){window.attachEvent("onbeforeunload",closeView)}if(window.addEventListener){window.addEventListener("beforeunload",closeView)}}else{if(window.attachEvent){window.attachEvent("onbeforeunload",closeView)}if(window.addEventListener){window.addEventListener("beforeunload",closeView)}}rs.EleResize.on(_view.opt.dom,resizeView);if(rs._browser.versions.mobile){initMobileEvent(callback)}else{initPCEvent(callback)}};var initPCEvent=function(){var canvas=$("#"+_view._canvas_id);canvas.on("dblclick",function(evt){evt.preventDefault();var service_string={service_id:"input.on_lbt_db_click",x:evt.offsetX*rs._browser.ratioZoom,y:evt.offsetY*rs._browser.ratioZoom,ctrl:evt.ctrlKey,shift:evt.shiftKey};service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string))});canvas.on("mousedown",function(evt){var service_string;switch(evt.button){case 0:service_string={service_id:"input.on_lbt_down",x:evt.offsetX*rs._browser.ratioZoom,y:evt.offsetY*rs._browser.ratioZoom,ctrl:evt.ctrlKey,shift:evt.shiftKey};rs._log("mousedown: "+evt.offsetX+","+evt.offsetY);lbt=1;if(typeof page_lbt_down=="function"){page_lbt_down(evt)}break;case 1:service_string={service_id:"input.on_mbt_down",x:evt.offsetX*rs._browser.ratioZoom,y:evt.offsetY*rs._browser.ratioZoom,ctrl:evt.ctrlKey,shift:evt.shiftKey};mbt=1;break;case 2:service_string={service_id:"input.on_rbt_down",x:evt.offsetX*rs._browser.ratioZoom,y:evt.offsetY*rs._browser.ratioZoom,ctrl:evt.ctrlKey,shift:evt.shiftKey};rbt=1;break}service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string))});canvas.on("mouseup",function(evt){doMouseUp(evt)});function doMouseUp(evt){var service_string;switch(evt.button){case 0:service_string={service_id:"input.on_lbt_up",x:evt.offsetX*rs._browser.ratioZoom,y:evt.offsetY*rs._browser.ratioZoom,ctrl:evt.ctrlKey,shift:evt.shiftKey};lbt=0;break;case 1:service_string={service_id:"input.on_mbt_up",x:evt.offsetX*rs._browser.ratioZoom,y:evt.offsetY*rs._browser.ratioZoom,ctrl:evt.ctrlKey,shift:evt.shiftKey};mbt=0;break;case 2:service_string={service_id:"input.on_rbt_up",x:evt.offsetX*rs._browser.ratioZoom,y:evt.offsetY*rs._browser.ratioZoom,ctrl:evt.ctrlKey,shift:evt.shiftKey};rbt=0;break}service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string))}var dragging=false;canvas.on("mousemove",function(evt){evt.preventDefault();dragging=true;var service_string={service_id:"input.on_mouse_move",lbt:lbt,mbt:mbt,rbt:rbt,x:evt.offsetX*rs._browser.ratioZoom,y:evt.offsetY*rs._browser.ratioZoom,ctrl:evt.ctrlKey,shift:evt.shiftKey};service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string))});canvas.on("mouseout",function(evt){if(dragging){evt.preventDefault();doMouseUp(evt);dragging=false}});canvas.on("mousewheel",function(evt){evt.preventDefault();var service_string={service_id:"input.on_mouse_wheel",delta:evt.originalEvent.wheelDelta,x:evt.originalEvent.offsetX*rs._browser.ratioZoom,y:evt.originalEvent.offsetY*rs._browser.ratioZoom,ctrl:evt.ctrlKey,shift:evt.shiftKey};service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string))});window.onkeydown=function(evt){rs._log("keydown");rs._log(evt);var service_string={service_id:"input.on_key_down",key:evt.keyCode,ctrl:evt.ctrlKey,shift:evt.shiftKey};service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string));window.focus()};window.onkeyup=function(evt){var service_string={service_id:"input.on_key_up",key:evt.keyCode,ctrl:evt.ctrlKey,shift:evt.shiftKey};service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string));window.focus()};if(typeof callback=="function"){callback()}};var initMobileEvent=function(){var canvas=$("#"+_view._canvas_id);var offset=canvas.offset();var x_before=offset.top,y_before=offset.left;var start_touches=[];var move_start_touches=[];var move_last_touches=[];var start_touch_time=0;var start_move=0;var rotate=0;var drag=0;var touchstart_time=[];var touchstart_history={};canvas.on("touchstart",function(evt){var touches=evt.originalEvent.touches;if(touches.length==1){var service_string={service_id:"input.on_lbt_down",x:touches[0].pageX,y:touches[0].pageY,ctrl:false,shift:false};touchstart_history.pageX=touches[0].pageX;touchstart_history.pageY=touches[0].pageY;touchstart_history.time=new Date().getTime();service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string));if(typeof page_touch_start=="function"){page_touch_start(evt)}}else{if(touches.length==2){}}});canvas.on("touchmove",function(evt){evt.preventDefault();var touches=evt.originalEvent.touches;if(touches.length==2){if(!drag){var service_string={service_id:"input.on_two_finger",x1:touches[0].pageX,y1:touches[0].pageY,x2:touches[1].pageX,y2:touches[1].pageY,state:1};service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string))}else{var service_string={service_id:"input.on_two_finger_hover",x1:touches[0].pageX,y1:touches[0].pageY,x2:touches[1].pageX,y2:touches[1].pageY,state:1};service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string))}}else{if(touches.length==1){var service_string={service_id:"input.on_mouse_move",lbt:1,mbt:0,rbt:0,x:touches[0].pageX,y:touches[0].pageY,ctrl:false,shift:false};service_string.render_uuid=render_uuid;_view._ws.send(JSON.stringify(service_string))}}});canvas.on("touchend touchcancel",function(evt){evt.preventDefault();start_touches=[];move_start_touches=[];move_last_touches=[];rotate_start_point=[];start_touch_time=0;start_move=0;rotate=0;drag=0;var end_time=new Date().getTime();if(end_time-touchstart_history.time<1000){_view._ws.send(JSON.stringify({service_id:"input.on_lbt_up",x:touchstart_history.pageX,y:touchstart_history.pageY,ctrl:false,shift:false,render_uuid:render_uuid}))}else{var touches=evt.originalEvent.touches;_view._ws.send(JSON.stringify({service_id:"input.on_lbt_up",x:touches[0].pageX,y:touches[0].pageY,ctrl:false,shift:false,render_uuid:render_uuid}))}_view._ws.send(JSON.stringify({service_id:"input.on_two_finger",state:0,render_uuid:render_uuid}))});canvas=canvas[0];touch.on(canvas,"hold",function(evt){evt=evt.originEvent;evt.preventDefault();var touches=evt.touches;if(touches.length>1){drag=1;return}if(events.hold){var touch=evt.touches[0];_view._ws.send(JSON.stringify({service_id:"convert.client_pt_to_3d",x:touch.pageX,y:touch.pageY,callback_service:{service_id:"page.call_function",event:"hold",data:"$pos$"},render_uuid:render_uuid}));events_evt.hold=evt}});touch.on(canvas,"doubletap",function(evt){evt.preventDefault();evt.originEvent.preventDefault();_view._ws.send(JSON.stringify({service_id:"input.on_lbt_db_click",x:evt.position.x,y:evt.position.y,ctrl:false,shift:false,render_uuid:render_uuid}));if(events.doubletap){events.doubletap.call(w3d,evt.originEvent,{})}});if(typeof callback=="function"){callback()}};var unEvent=function(){var canvas=$("#"+_view._canvas_id);canvas.off("")}}};var init25Map=function(){if(!_view._canvas){(function(){var org_forward=ol.proj.getTransform("EPSG:4326","EPSG:3857");var org_inverse=ol.proj.getTransform("EPSG:3857","EPSG:4326");var xf=13684.22012323-278,yf=5228.42439159-1345;var xi=0.122858-0.002428,yi=0.036515-0.00620808;var forward=function(input){var output=org_forward(input);output[0]=output[0]-xf;output[1]=output[1]-yf;return output};var inverse=function(input){var output=org_inverse(input);output[0]=output[0]+xi;output[1]=output[1]+yi;return output};ol.proj.addCoordinateTransforms("EPSG:4326","EPSG:3857",forward,inverse)})();_view._canvas=new ol.Map({target:_view._dom_id,logo:false,controls:[new ol.control.Zoom(),new ol.control.MousePosition({projection:new ol.proj.Projection({code:"EPSG:4326"})}),new ol.control.Rotate({autoHide:true})],interactions:ol.interaction.defaults({doubleClickZoom:false}),layers:[new ol.layer.Tile({opacity:1,source:new ol.source.XYZ({tileUrlFunction:function(coord){if(!coord){return}var z=coord[0],x=coord[1],y=coord[2];var max=Math.pow(2,z)-1;y=max-y;var name=z+"_"+x+"_"+y;if(z>4){var tmp=z,path="";while(tmp>4){var c=1<<tmp%5;x=Math.floor(x/c);y=Math.floor(y/c);path=x+"_"+y+"/"+path;tmp=(tmp-tmp%5)-5;x=x/32;y=y/32}name=path+name}return rs._api_base+"t/00/0_0/"+name+".png"},minZoom:4,maxZoom:24,wrapX:false,projection:new ol.proj.Projection({code:"EPSG:3857",units:"m"})})})],view:new ol.View({projection:"EPSG:3857",center:ol.proj.transform([110.502,38.833],"EPSG:4326","EPSG:3857"),zoom:4})});rs._eventCall(_view,rs.event.ready);_view._canvas.on("click",function(evt){var point=ol.proj.transform(evt.coordinate,"EPSG:3857","EPSG:4326");var data={pos:{longitude:point[0],latitude:point[1]},x:evt.pixel[0],y:evt.pixel[1]};rs._eventCall(_view,rs.event.click,data)})}};switch(render){case"3d":rs.server_info.init(initEmbed);break;case"3d-cloud-remote":rs.server_info.init(initCloudRemote);break;case"3d-cloud":rs.server_info.init(initCloud);break;default:init25Map();break}};rs.View.prototype.pause=function(){var a=this};rs.View.prototype.resume=function(){var a=this};rs.View.prototype.getVersion=function(){var a=this;return this.opt.version};rs.View.prototype.getCamera=function(){var b=this;var a=function(){this.locate=function(f){if(b.opt.render!="3d"&&this.opt.render!="3d-cloud"&&this.opt.render!="3d-cloud-remote"){if(!rs._isArray(f.pos_pose)){f.pos_pose=[f.pos_pose]}var d=[f.pos_pose[0].longitude,f.pos_pose[0].latitude];b._canvas.getView().setCenter(ol.proj.transform(d,"EPSG:4326","EPSG:3857"));var c=f.pos_pose[0].height;var j=[8800000,3730000,1660000,930000,579892,324385,103812,72827,33128,21331,9884,6631,3139,2282,1272,1098,907,855,821,796,786];var h=[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24];var g=0;if(c<25&&c>4){g=c}else{if(c>j[0]){g=h[0]}else{if(c<j[j.length-1]){g=h[h.length-1]}else{var e=0;while(e<j.length-1){if(c<=j[e]&&c>j[e+1]){g=h[e];break}e++}}}}if(g>0){b._canvas.getView().setZoom(g)}return}if(f){f.service_id="camera.locate"}rs._serviceCall(b,f)}};a.prototype=new rs.camera.Base();return new a()};rs.View.prototype.getLayers=function(){return this._layer_list};rs.View.prototype.getLayer=function(b){for(var a=0;a<this._layer_list.length;a++){var c=this._layer_list[a].getId();if(c==b){return this._layer_list[a]}}return null};rs.View.prototype.getLayersByName=function(c){var d=[];for(var b=0;b<this._layer_list.length;b++){var a=this._layer_list[b].getName();if(a==c){d.push(this._layer_list[b])}}return d};rs.View.prototype.addLayer=function(b){if(!(b instanceof rs.layer.Base)){throw Error("addLayer param error")}b._view=this;this._layer_list.push(b);if(this.opt.render!="3d"&&this.opt.render!="3d-cloud"&&this.opt.render!="3d-cloud-remote"){if(b instanceof rs.layer.Vector){var a=new ol.layer.Vector({source:new ol.source.Vector(),style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#34E44F",width:5}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})});this._canvas.addLayer(a);b._canvas=a}}};rs.View.prototype.removeLayer=function(b){var d=this;if(b instanceof rs.layer.Base){b=b.getId()}for(var a=0;a<d._layer_list.length;a++){var c=d._layer_list[a].getId();if(c==layer_id){d._layer_list.splice(a,1);return}}};rs.View.prototype.hasLayer=function(b){var d=this;if(b instanceof rs.layer.Base){b=b.getId()}for(var a=0;a<d._layer_list.length;a++){var c=d._layer_list[a].getId();if(c==b){return true}}return false};rs.View.prototype.on=function(b,a,c){rs._eventOn(this,b,a,c)};rs.View.prototype.once=function(b,a){rs._eventOnce(this,b,a,true)};rs.View.prototype.off=function(a){rs._eventOff(this,a)};rs.View.prototype.setRender=function(a){var b=this};rs.View.prototype.debug=function(a){};rs.define("rs.RemoteView");rs.RemoteView=function(c){this._canvas=null;this._canvas_id="resafety-web3d-embed";this._exe_title="";this._terminal_id=null;this._event_list={};this._layer_list=[];var a={};var b={};this._terminal_id=c;if(!this._terminal_id){throw Error("no terminal_id for RemoteView")}var d=this._terminal_id;this._canvas={call_service:function(e){rs._toServerService(e,d)}}};rs.RemoteView.prototype.pause=function(){var a=this};rs.RemoteView.prototype.resume=function(){var a=this};rs.RemoteView.prototype.getVersion=function(){var a=this;return this.opt.version};rs.RemoteView.prototype.getCamera=function(){var b=this;var a=function(){this.locate=function(c){if(c){c.service_id="camera.locate"}rs._serviceCall(b,c)}};a.prototype=new rs.camera.Base();return new a()};rs.RemoteView.prototype.getLayers=function(){return this._layer_list};rs.RemoteView.prototype.getLayer=function(b){for(var a=0;a<this._layer_list.length;a++){var c=this._layer_list[a].getId();if(c==b){return this._layer_list[a]}}return null};rs.RemoteView.prototype.addLayer=function(b){if(!(b instanceof rs.layer.Base)){throw Error("addLayer param error")}b._view=this;this._layer_list.push(b);if(this.opt.render!="3d"){if(b instanceof rs.layer.Vector){var a=new ol.layer.Vector({source:new ol.source.Vector(),style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#34E44F",width:5}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})});this._canvas.addLayer(a);b._canvas=a}}};rs.RemoteView.prototype.removeLayer=function(b){var d=this;if(b instanceof rs.layer.Base){b=b.getId()}for(var a=0;a<d._layer_list.length;a++){var c=d._layer_list[a].getId();if(c==layer_id){d._layer_list.splice(a,1);return}}};rs.RemoteView.prototype.hasLayer=function(b){var d=this;if(b instanceof rs.layer.Base){b=b.getId()}for(var a=0;a<d._layer_list.length;a++){var c=d._layer_list[a].getId();if(c==b){return true}}return false};rs.RemoteView.prototype.on=function(b,a,c){rs._eventOn(this,b,a,c)};rs.RemoteView.prototype.once=function(b,a){rs._eventOnce(this,b,a,true)};rs.RemoteView.prototype.off=function(a){rs._eventOff(this,a)};rs.RemoteView.prototype.setRender=function(a){var b=this};rs.define("rs.camera.Base");rs.camera.Base=function(){};rs.define("rs.layer.Base");rs.layer.Base=function(){};rs.define("rs.layer.Vector");rs.layer.Vector=function(c){rs.layer.Base.apply(this,arguments);this._id=null;this._view=null;this._canvas=null;this._object_list=[];var a={name:null,visible:true,objects:[]};var b=rs._isString(c)?{name:c}:c;this.opt=rs._merge({},a,b);if(!this.opt.name){throw Error("no name for layer.Vector")}if(this.opt.objects){this._object_list=this._object_list.concat(this.opt.objects)}this._id=rs._random()};rs.inherits(rs.layer.Vector,rs.layer.Base);rs.layer.Vector.prototype.setName=function(a){this.opt.name=a};rs.layer.Vector.prototype.getName=function(){return this.opt.name};rs.layer.Vector.prototype.getId=function(){return this._id};rs.layer.Vector.prototype.getObjects=function(){return this._object_list};rs.layer.Vector.prototype.getObject=function(b){if(!b){return null}var d=this;for(var a=0;a<d._object_list.length;a++){var c=d._object_list[a].getId();if(c==b){return d._object_list[a]}}return null};rs.layer.Vector.prototype.getObjectsByName=function(a){if(!a){return[]}var d=[];var e=this;for(var c=0;c<e._object_list.length;c++){var b=e._object_list[c].getName();if(b==a){d.push(e._object_list[c])}}return d};rs.layer.Vector.prototype.getObjectsByAttr=function(e,b){if(!e){return[]}var c=[];var f=this;for(var a=0;a<f._object_list.length;a++){var d=f._object_list[a].getAttr(e);if(d==b){c.push(f._object_list[a])}}return c};rs.layer.Vector.prototype.hasObject=function(a){var d=this;if(a instanceof rs.object.Base){a=a.getId()}for(var b=0;b<d._object_list.length;b++){var c=d._object_list[b].getId();if(c==a){return true}}return false};rs.layer.Vector.prototype.addObject=function(b){var f=this;if(!(b instanceof rs.object.Base)){throw Error("addObject param error")}f._object_list.push(b);if(f._view){if(f._view.opt.render!="3d"&&f._view.opt.render!="3d-cloud"){if(b instanceof rs.object.EffectSpaceLine){var j=[];for(var d=0;d<b.opt.pos.length;d++){j.push([b.opt.pos[d]["longitude"],b.opt.pos[d]["latitude"]])}var g=new ol.geom.LineString(j).transform("EPSG:4326","EPSG:3857");var k=new ol.Feature({geometry:g,name:b.opt.name});var a=new ol.style.Style({fill:new ol.style.Fill({color:b.opt.color}),stroke:new ol.style.Stroke({color:b.opt.color,width:5})});k.setStyle(a);f._canvas.getSource().addFeature(k)}else{if(b instanceof rs.object.EffectColorCover){var j=[];for(var d=0;d<b.opt.pos.length;d++){j.push([b.opt.pos[d]["longitude"],b.opt.pos[d]["latitude"]])}var g=new ol.geom.Polygon([j]).transform("EPSG:4326","EPSG:3857");var k=new ol.Feature({geometry:g,name:b.opt.name});var a=new ol.style.Style({fill:new ol.style.Fill({color:b.opt.color}),stroke:new ol.style.Stroke({color:b.opt.color,width:5})});k.setStyle(a);f._canvas.getSource().addFeature(k)}else{if(b instanceof rs.object.EffectScreenImage){var h=[b.opt.pos.longitude,b.opt.pos.latitude];var g=new ol.geom.Point(h).transform("EPSG:4326","EPSG:3857");var k=new ol.Feature({geometry:g,name:b.opt.name,population:4000,rainfall:500});var a=new ol.style.Style({image:new ol.style.Icon({anchor:[0.5,0.5],anchorOrigin:"bottom-left",offsetOrigin:"bottom-left",anchorXUnits:"fraction",anchorYUnits:"fraction",opacity:0.75,src:b.opt.tex,size:[b.opt.width,b.opt.height]})});k.setStyle(a);f._canvas.getSource().addFeature(k)}else{if(b instanceof rs.object.EffectRotateImage){var h=[b.opt.pos.longitude,b.opt.pos.latitude];var g=new ol.geom.Point(h).transform("EPSG:4326","EPSG:3857");var k=new ol.Feature({geometry:g,name:b.opt.name,population:4000,rainfall:500});var a=new ol.style.Style({image:new ol.style.Icon({anchor:[0.5,0.5],anchorOrigin:"bottom-left",offsetOrigin:"bottom-left",anchorXUnits:"fraction",anchorYUnits:"fraction",opacity:0.75,src:b.opt.tex,size:[b.opt.pic_width,b.opt.pic_height]})});k.setStyle(a);f._canvas.getSource().addFeature(k)}else{if(b instanceof rs.object.EffectHTMLLabel){var c=rs._get("#_3d_view_popup");if(!c){c=document.createElement("div");c.id="_3d_view_popup";c.className="ol-popup";c.innerHTML='<a href="javascript:;" id="_3d_view_popup_closer" class="ol-popup-closer"></a><div id="_3d_view_popup_content"></div>';document.body.appendChild(c)}b._dom=c;b._overlay=new ol.Overlay({element:c,autoPan:true,autoPanAnimation:{duration:250}});f._view._canvas.addOverlay(b._overlay);setTimeout(function(){var i=rs._get("#_3d_view_popup_closer");i.onclick=function(){b._overlay.setPosition(undefined);i.blur();return false}},100)}}}}}}else{var e;if(b instanceof rs.object.EffectModel){e={service_id:"effect.model.create",model:b.opt.model,pos:b.opt.pos,pose:b.opt.pose,scale:b.opt.scale,show:0,effect_id:b._id};if(b.opt.on_left_dbclick){e.on_left_dbclick=b.opt.on_left_dbclick}if(b.opt.on_right_click){e.on_right_click=b.opt.on_right_click}if(b.opt.on_right_menu){e.on_right_menu=b.opt.on_right_menu}}else{if(b instanceof rs.object.EffectPipe){e={service_id:"effect.pipe.create",tex:b.opt.tex,pos:b.opt.pos,radius:b.opt.radius,side:b.opt.side,rcc:b.opt.rcc,ral:b.opt.ral,effect_id:b._id}}else{if(b instanceof rs.object.EffectScreenImage){e={service_id:"effect.screen_image.create",tex:b.opt.tex,pos:b.opt.pos,width:b.opt.width,height:b.opt.height,min_show_height:b.opt.min_show_height,max_show_height:b.opt.max_show_height,max_view_dis:b.opt.max_show_height,content:b.opt.name,avoid:0,color:rs._formatColorHex(b.opt.color),show:0,offset:b.opt.offset,effect_id:b._id};if(b.opt.on_left_dbclick){e.on_left_dbclick=b.opt.on_left_dbclick}if(b.opt.on_left_click){e.on_left_click=b.opt.on_left_click}if(b.opt.on_right_click){e.on_right_click=b.opt.on_right_click}if(b.opt.on_right_menu){e.on_right_menu=b.opt.on_right_menu}}else{if(b instanceof rs.object.EffectRotateImage){e={service_id:"effect.rotate_image.create",name:b.opt.name,tex:b.opt.tex,pos:b.opt.pos,angle:b.opt.angle,align:b.opt.align,pic_width:b.opt.pic_width,pic_height:b.opt.pic_height,min_show_height:b.opt.min_show_height,max_show_height:b.opt.max_show_height,max_view_dis:b.opt.max_show_height,content:b.opt.name,avoid:0,color:rs._formatColorHex(b.opt.color),show:0,offset:b.opt.offset,effect_id:b._id};if(b.opt.on_left_dbclick){e.on_left_dbclick=b.opt.on_left_dbclick}if(b.opt.on_left_click){e.on_left_click=b.opt.on_left_click}if(b.opt.on_right_click){e.on_right_click=b.opt.on_right_click}if(b.opt.on_right_menu){e.on_right_menu=b.opt.on_right_menu}}else{if(b instanceof rs.object.EffectRadar){e={service_id:"effect.radar.create",color:rs._formatColorHex(b.opt.color),speed:b.opt.speed,radius:b.opt.radius,count:b.opt.count,pos:b.opt.pos,show:0,effect_id:b._id};if(b.opt.on_left_dbclick){e.on_left_dbclick=b.opt.on_left_dbclick}if(b.opt.on_right_click){e.on_right_click=b.opt.on_right_click}if(b.opt.on_right_menu){e.on_right_menu=b.opt.on_right_menu}}else{if(b instanceof rs.object.EffectSpaceLine){e={service_id:"effect.space_line.create",pos:b.opt.pos,color:rs._formatColorHex(b.opt.color),effect_id:b._id}}else{if(b instanceof rs.object.EffectColorCover){e={service_id:"effect.color_cover.create",pos:b.opt.pos,color:rs._formatColorHex(b.opt.color),effect_id:b._id}}else{if(b instanceof rs.object.EffectTextureLabel){e={service_id:"effect.texture_label.create",pos:b.opt.pos,title:b.opt.title,contents:b.opt.contents,effect_id:b._id}}}}}}}}}if(e){rs._serviceCall(f._view,e)}}}for(var d=0;d<b._layers_in.length;d++){if(f==b._layers_in[d]){return}}b._layers_in.push(f)};rs.layer.Vector.prototype.addObjects=function(h){var e=this;if(!(h[0] instanceof rs.object.Base)){throw Error("addObjects param error")}if(e._view){if(e._view.opt.render!="3d"&&e._view.opt.render!="3d-cloud"&&e._view.opt.render!="3d-cloud-remote"){}else{var g=[];for(var c=0;c<h.length;c++){var a=h[c];e._object_list.push(a);var d;if(a instanceof rs.object.EffectModel){d={service_id:"effect.model.create",model:a.opt.model,pos:a.opt.pos,pose:a.opt.pose,scale:a.opt.scale,show:0,effect_id:a._id};if(a.opt.on_left_dbclick){d.on_left_dbclick=a.opt.on_left_dbclick}if(a.opt.on_right_click){d.on_right_click=a.opt.on_right_click}if(a.opt.on_right_menu){d.on_right_menu=a.opt.on_right_menu}}else{if(a instanceof rs.object.EffectPipe){d={service_id:"effect.pipe.create",tex:a.opt.tex,pos:a.opt.pos,radius:a.opt.radius,side:a.opt.side,rcc:a.opt.rcc,ral:a.opt.ral,effect_id:a._id}}else{if(a instanceof rs.object.EffectScreenImage){d={service_id:"effect.screen_image.create",tex:a.opt.tex,pos:a.opt.pos,width:a.opt.width,height:a.opt.height,min_show_height:a.opt.min_show_height,max_show_height:a.opt.max_show_height,max_view_dis:a.opt.max_show_height,content:a.opt.name,avoid:0,color:rs._formatColorHex(a.opt.color),show:0,offset:a.opt.offset,effect_id:a._id};if(a.opt.on_left_dbclick){d.on_left_dbclick=a.opt.on_left_dbclick}if(a.opt.on_left_click){d.on_left_click=a.opt.on_left_click}if(a.opt.on_right_click){d.on_right_click=a.opt.on_right_click}if(a.opt.on_right_menu){d.on_right_menu=a.opt.on_right_menu}}else{if(a instanceof rs.object.EffectRotateImage){d={service_id:"effect.rotate_image.create",name:a.opt.name,tex:a.opt.tex,pos:a.opt.pos,angle:a.opt.angle,align:a.opt.align,pic_width:a.opt.pic_width,pic_height:a.opt.pic_height,min_show_height:a.opt.min_show_height,max_show_height:a.opt.max_show_height,max_view_dis:a.opt.max_show_height,content:a.opt.name,avoid:0,color:rs._formatColorHex(a.opt.color),show:0,offset:a.opt.offset,effect_id:a._id};if(a.opt.on_left_dbclick){d.on_left_dbclick=a.opt.on_left_dbclick}if(a.opt.on_left_click){d.on_left_click=a.opt.on_left_click}if(a.opt.on_right_click){d.on_right_click=a.opt.on_right_click}if(a.opt.on_right_menu){d.on_right_menu=a.opt.on_right_menu}}else{if(a instanceof rs.object.EffectRadar){d={service_id:"effect.radar.create",color:rs._formatColorHex(a.opt.color),speed:a.opt.speed,radius:a.opt.radius,count:a.opt.count,pos:a.opt.pos,show:0,effect_id:a._id};if(a.opt.on_left_dbclick){d.on_left_dbclick=a.opt.on_left_dbclick}if(a.opt.on_right_click){d.on_right_click=a.opt.on_right_click}if(a.opt.on_right_menu){d.on_right_menu=a.opt.on_right_menu}}else{if(a instanceof rs.object.EffectSpaceLine){d={service_id:"effect.space_line.create",pos:a.opt.pos,color:rs._formatColorHex(a.opt.color),effect_id:a._id}}else{if(a instanceof rs.object.EffectColorCover){d={service_id:"effect.color_cover.create",pos:a.opt.pos,color:rs._formatColorHex(a.opt.color),effect_id:a._id}}else{if(a instanceof rs.object.EffectTextureLabel){d={service_id:"effect.texture_label.create",pos:a.opt.pos,title:a.opt.title,contents:a.opt.contents,effect_id:a._id}}}}}}}}}d.group_id=rs._effect_group_id;g.push(d);var f=false;for(var b=0;b<a._layers_in.length;b++){if(e==a._layers_in[b]){f=true;break}}if(!f){a._layers_in.push(e)}if(g.length>=10){var k={service_id:"advanced_service.bat_service",service_string:g};rs._serviceCall(e._view,k);g=[]}}if(g.length>=0){var k={service_id:"advanced_service.bat_service",service_string:g};rs._serviceCall(e._view,k)}}}};rs.layer.Vector.prototype.removeObject=function(c){var g=this;if(c instanceof rs.object.Base){c=c.getId()}for(var d=0;d<g._object_list.length;d++){var e=g._object_list[d];var f=e.getId();if(f==c){g._object_list.splice(d,1);for(var b=0;b<e._layers_in.length;b++){if(g==e._layers_in[b]){e._layers_in.splice(b,1);break}}return}}if(g._view){var a={service_id:"effect.remove",effect_id:c};rs._serviceCall(g._view,a)}};rs.layer.Vector.prototype.clear=function(){var d=this;var c=[];while(d._object_list.length>0){if(d._object_list[0] instanceof rs.object.Effect){c.push(d._object_list[0].getId())}d.removeObject(0)}if(d._view&&c.length>0){var a=[];for(var b=0;b<c.length;b++){a.push({service_id:"effect.remove",effect_id:c[b]})}rs._serviceCall(d._view,a)}};rs.layer.Vector.prototype.setVisible=function(c){var d=this;d.opt.visible=!!c;var b=d._object_list;for(var a=0;a<b.length;a++){b[a].setVisible(d.opt.visible)}};rs.layer.Vector.prototype.isVisible=function(){var a=this;return a.opt.visible};rs.define("rs.object.Base");rs.object.Base=function(){};rs.define("rs.object.Scene");rs.object.Scene=function(){rs.object.Base.call(this,arguments)};rs.inherits(rs.object.Scene,rs.object.Base);rs.define("rs.object.Effect");rs.object.Effect=function(){rs.object.Base.apply(this,arguments);this._id=null;this._attr={};this._event_list={};this._layers_in=[];this.opt=null;this._id=rs._random()};rs.inherits(rs.object.Effect,rs.object.Base);rs.object.Effect.prototype.modify=function(a){this.opt=rs._merge(this.opt,a)};rs.object.Effect.prototype.setName=function(a){this.opt.name=a};rs.object.Effect.prototype.getName=function(){return this.opt.name};rs.object.Effect.prototype.getId=function(){return this._id};rs.object.Effect.prototype.getLayers=function(){return this._layers_in};rs.object.Effect.prototype.setVisible=function(g){var f=this;f.opt.visible=!!g;var b;var d=f._layers_in;for(var c=0;c<d.length;c++){if(d[c]._view){b=d[c]._view;break}}if(b){if(b.opt.render=="3d"||b.opt.render=="3d-cloud"||b.opt.render=="3d-cloud-remote"){rs._serviceCall(b,{service_id:"effect.show",effect_id:f._id,show:f.opt.visible?1:0})}else{if(f instanceof rs.object.EffectHTMLLabel){var h=f.opt.pos;var a=[h.longitude,h.latitude];var e=rs._get("#_3d_view_popup_content");e.innerHTML=f.opt.html;e.style.width=f.opt.width+"px";e.style.height=f.opt.height+"px";f._overlay.setPosition(ol.proj.transform(a,"EPSG:4326","EPSG:3857"))}}}};rs.object.Effect.prototype.isVisible=function(){var a=this;return a.opt.visible};rs.object.Effect.prototype.setAttr=function(a){var b=this;b._attr=rs._merge(true,{},b._attr,a)};rs.object.Effect.prototype.getAttr=function(a){var b=this;return b._attr[a]};rs.object.Effect.prototype.on=function(b,a,c){rs._eventOn(this,b,a,c)};rs.object.Effect.prototype.once=function(b,a){rs._eventOnce(this,b,a,true)};rs.object.Effect.prototype.off=function(a){rs._eventOff(this,a)};rs.define("rs.object.EffectModel");rs.object.EffectModel=function(b){rs.object.Effect.apply(this,arguments);var a={name:null,model:null,visible:true,pos:{longitude:null,latitude:null,height:null},object_id:null,pose:{alpha:null,course:null,roll:null},scale:{length:null,width:null,height:null}};this.opt=rs._merge({},a,b);if(!this.opt.name){throw Error("no name for rs.object.EffectModel")}if(!this.opt.model){throw Error("no model for rs.object.EffectModel")}};rs.inherits(rs.object.EffectModel,rs.object.Effect);rs.define("rs.object.EffectPipe");rs.object.EffectPipe=function(b){rs.object.Effect.apply(this,arguments);var a={name:null,tex:null,visible:true,pos:[{longitude:null,latitude:null,height:null}],object_id:[null],color:null,radius:1,side:8,rcc:1,ral:10};this.opt=rs._merge({},a,b);if(!this.opt.name){throw Error("no name for rs.object.EffectPipe")}if(!this.opt.model_file){throw Error("no tex for rs.object.EffectPipe")}};rs.inherits(rs.object.EffectPipe,rs.object.Effect);rs.define("rs.object.EffectColorCover");rs.object.EffectColorCover=function(b){rs.object.Effect.apply(this,arguments);var a={name:null,visible:true,pos:[{longitude:null,latitude:null,height:null}],object_id:[null],color:null};this.opt=rs._merge({},a,b);if(!this.opt.name){throw Error("no name for rs.object.EffectColorCover")}if(!this.opt.pos){throw Error("no pos for rs.object.EffectColorCover")}};rs.inherits(rs.object.EffectColorCover,rs.object.Effect);rs.define("rs.object.EffectScreenImage");rs.object.EffectScreenImage=function(b){rs.object.Effect.apply(this,arguments);var a={name:null,tex:null,visible:true,pos:{longitude:null,latitude:null,height:null},offset:{x:null,y:null},color:null,width:200,height:200,min_show_height:50,max_show_height:5000000};this.opt=rs._merge({},a,b);if(!this.opt.name){throw Error("no name for rs.object.EffectScreenImage")}if(!this.opt.tex){throw Error("no tex for rs.object.EffectScreenImage")}};rs.inherits(rs.object.EffectScreenImage,rs.object.Effect);rs.define("rs.object.EffectRotateImage");rs.object.EffectRotateImage=function(b){rs.object.Effect.apply(this,arguments);var a={name:null,tex:null,visible:true,pos:{longitude:null,latitude:null,height:null},angle:0,align:5,offset:{x:null,y:null},color:null,pic_width:50,pic_height:50,min_show_height:50,max_show_height:5000000};this.opt=rs._merge({},a,b);if(!this.opt.name){throw Error("no name for rs.object.EffectRotateImage")}if(!this.opt.tex){throw Error("no tex for rs.object.EffectRotateImage")}};rs.inherits(rs.object.EffectRotateImage,rs.object.Effect);rs.define("rs.object.EffectRadar");rs.object.EffectRadar=function(b){rs.object.Effect.apply(this,arguments);var a={name:null,color:"0xffff0000",speed:3,radius:20,count:50,pos:{longitude:null,latitude:null,height:null}};this.opt=rs._merge({},a,b);if(!this.opt.name){throw Error("no name for rs.object.EffectRadar")}if(!this.opt.pos){throw Error("no tex for rs.object.EffectRadar")}};rs.inherits(rs.object.EffectRadar,rs.object.Effect);rs.define("rs.object.EffectSpaceLine");rs.object.EffectSpaceLine=function(b){rs.object.Effect.apply(this,arguments);var a={name:null,visible:true,pos:[{longitude:null,latitude:null,height:null}],color:null};this.opt=rs._merge({},a,b);if(!this.opt.pos){throw Error("no pos for rs.object.EffectSpaceLine")}};rs.inherits(rs.object.EffectSpaceLine,rs.object.Effect);rs.define("rs.object.EffectTextureLabel");rs.object.EffectTextureLabel=function(b){rs.object.Effect.apply(this,arguments);var a={name:null,visible:true,pos:[{longitude:null,latitude:null,height:null}],title:{content:null,font:{name:null,size:14,color:null,background_color:null}},contents:[]};this.opt=rs._merge({},a,b);if(!this.opt.pos){throw Error("no pos for rs.object.EffectTextureLabel")}};rs.inherits(rs.object.EffectTextureLabel,rs.object.Effect);rs.define("rs.object.EffectHTMLLabel");rs.object.EffectHTMLLabel=function(b){rs.object.Effect.apply(this,arguments);var a={name:null,visible:false,pos:{longitude:null,latitude:null,height:null},width:180,height:140,html:""};this.opt=rs._merge({},a,b);if(!this.opt.pos){throw Error("no pos for rs.object.EffectHTMLLabel")}};rs.inherits(rs.object.EffectHTMLLabel,rs.object.Effect);rs.page={};rs.page.toServerService=function(a,b){if(!a||!b){return}rs._ajax(rs._api_base+"service/exec",{service:JSON.stringify(a),terminal_id:b})};rs.page.callService=function(service,async){if(typeof(service)=="string"){try{service=eval("("+service+")")}catch(e){alert("error："+service+" 格式错误")}}if(!service){return}async=async===false?false:true;if(rs._isArray(service)){for(var i=0;i<service.length;i++){rs.page.callService(service[i],async)}}else{var service_id=service.service_id;if(!service_id){var rp=rs.page.getDomainTopWindow().resafety_page||resafety_page;if(rp.debug){alert("error：没有service_id "+JSON.stringify(service))}return}var callback=service.callback;if(callback){if(typeof(callback)=="string"){callback=window[callback]}var key=rs._random();var top_rp=rs.page.getDomainTopWindow().resafety_page||resafety_page;top_rp.callback_cache[key]=callback;service.callback=key;console.log("发送消息： "+service.callback)}if(!rs.page.in_resafety_browser()||rs.page.is_must_to_server(service)){var terminal_id=rs.page.get_url_param("terminal_id");if((!terminal_id||terminal_id=="")&&service.terminal_id){terminal_id=service.terminal_id}rs.page.toServerService(service,terminal_id)}else{console.log("发送消息： "+JSON.stringify(service));rs.page.toServerAgent(service)}}};rs.page.toServerAgent=function(a){if(window.resafety_browser&&window.resafety_browser.call_service){if(!a.terminal_id||a.terminal_id==""){a.terminal_id="$resafety_browser_terminal_id$"}if(a.callback_service){if(rs._isArray(a.callback_service)){for(var c=0;c<a.callback_service.length;c++){if(!a.callback_service[c].terminal_id||a.callback_service.terminal_id[c]==""){a.callback_service[c].terminal_id="$resafety_browser_terminal_id$"}}}else{if(!a.callback_service.terminal_id||a.callback_service.terminal_id==""){a.callback_service.terminal_id="$resafety_browser_terminal_id$"}}}window.resafety_browser.call_service(JSON.stringify(a));return}var b=rs.page.getDomainTopWindow();if(b.resafety_browser&&b.resafety_browser.call_service){if(!a.terminal_id){a.terminal_id=rs.page.get_url_param("terminal_id")}if(!a.terminal_id||a.terminal_id==""){a.terminal_id="$resafety_browser_terminal_id$"}b.resafety_browser.call_service(JSON.stringify(a))}};rs.page.getDomainTopWindow=function(){var a=window;try{while(a.parent!=a&&a.parent.location.href){a=a.parent}}catch(b){}return a};rs.page.in_resafety_browser=function(){var a=rs.page.getDomainTopWindow();if(a.resafety_browser&&a.resafety_browser.call_service){return true}return false};rs.page.is_must_to_server=function(a){var b=a.service_id;if(b=="999999"||b=="browser.openModule"||b=="500"){return true}return false};rs.page.get_url_param=function(b,c){c=c||window.location.search;var d=new RegExp("(^|&)"+b+"=([^&]*)(&|$)");var e=c.substr(1).match(d);if(e!=null){return decodeURI(e[2])}else{var a=rs.page.getDomainTopWindow();e=a.location.search.substr(1).match(d);if(e!=null){return decodeURI(e[2])}}return null};